#####
#
# Copyright (C) 2003 Vincent Glaume <vglaume@exaprobe.com>
# All Rights Reserved
#
# This file is part of the Prelude program.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by 
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; see the file COPYING.  If not, write to
# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#
#####

# I. Starting / stopping squid, and associated services (informational, do not show a real attack)

###
# 1. Usual syslog file format
# Rules taken from /var/log/syslog (default Debian conf), same information as in cache.log but format differs
###

# starting squid
# No log sample; please submit
regex=squid\[(\d+)\]: Starting Squid Cache version ([\w\.]+) for ([\w-]+)\.\.\.; \
 classification.name=Squid started; \
 id=1800; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid version $2 was started with PID $1; \
 last

# accepting connections - is the node address really relevant here (-> listen on 0.0.0.0 for instance) ?
# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Accepting HTTP connections at ([\d\.]+), port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts HTTP; \
 id=1801; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid (PID $2) listens for incoming HTTP connections on $3:$4, file descriptor #$5; \
 target.node.name=$1; \
 target.node.address; \
 target.node.address.category=ipv4-addr; \
 target.node.address.address=$3; \
 target.service.port=$4; \
 target.process.pid=$2; \
 target.process.name=squid; \
 target.service.protocol=HTTP; \
 last

# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Accepting ICP messages at ([\d\.]+), port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts ICP; \
 id=1802; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid (PID $2) listens for incoming ICP messages on $3:$4, file descriptor #$5; \
 target.node.name=$1; \
 target.node.address; \
 target.node.address.category=ipv4-addr; \
 target.node.address.address=$3; \
 target.service.port=$4; \
 target.process.pid=$2; \
 target.process.name=squid; \
 target.service.protocol=ICP; \
 last

# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Accepting HTCP messages on port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts HTCP; \
 id=1803; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid (PID $2) listens for incoming HTCP messages on port $3, file descriptor #$4; \
 target.node.name=$1; \
 target.service.port=$3; \
 target.process.pid=$2; \
 target.process.name=squid; \
 target.service.protocol=HTCP; \
 last

# No log sample, please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Accepting WCCP messages on port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts WCCP; \
 id=1804; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid (PID $2) listens for incoming WCCP messages on port $3, file descriptor #$4; \
 target.node.name=$1; \
 target.service.port=$3; \
 target.process.pid=$2; \
 target.process.name=squid; \
 target.service.protocol=WCCP; \
 last

# disabled services (do we really need this ?)
# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: HTCP Disabled\.; \
 classification.name=Squid started without HTCP; \
 id=1805; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid (PID $2) was invoked without the HTCP service; \
 target.node.name=$1; \
 target.process.pid=$2; \
 target.process.name=squid; \
 last

# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: WCCP Disabled\.; \
 classification.name=Squid started without WCCP; \
 id=1806; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid (PID $2) was invoked without the WCCP service; \
 target.node.name=$1; \
 target.process.pid=$2; \
 target.process.name=squid; \
 last

# another way (less verbose) to detect squid has started (found in /var/log/messages and /var/log/syslog, default Debian conf)
# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Squid Parent: child process (\d+) started; \
 classification.name=Squid started; \
 id=1807; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid was started on $1 with pids $2 (parent) and $3 (child); \
 target.node.name=$1; \
 target.process.name=squid; \
 target.process.pid=$2; \
 last

# squid exiting (/var/log/syslog and /var/log/messages format)
# No log sample; please submit
regex=([\w\.]+) squid\[([0-9]+)\]: Squid Parent: child process (\d+) exited; \
 classification.name=Squid stopped; \
 id=1808; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid (pid $2) exited; \
 target.node.name=$1; \
 target.process.name=squid; \
 target.process.pid=$2; \
 last



###
# 2. Squid own format
# same as previous, but using the /var/log/squid/cache.log (do not use these ones if you can use the ones above)
###

# starting 
# No log sample; please submit
regex=Starting Squid Cache version ([\w\.]+) for ([\w-]+)\.\.\.; \
 classification.name=Squid started; \
 id=1809; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid version $1 was started; \
 last

# accepting connections or disabled servicesa
# No log sample; please submit
regex=Accepting HTTP connections at ([\d\.]+), port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts HTTP; \
 id=1810; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid listens for incoming HTTP connections on $1:$2, file descriptor #$3; \
 target.node.address; \
 target.node.address.category=ipv4-addr; \
 target.node.address.address=$1; \
 target.service.port=$2; \
 target.service.protocol=HTTP; \
 last

# No log sample; please submit
regex=Accepting ICP messages at ([\d\.]+), port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts ICP; \
 id=1811; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid listens for incoming ICP messages on $1:$2, file descriptor #$3; \
 target.node.address; \
 target.node.address.category=ipv4-addr; \
 target.node.address.address=$1; \
 target.service.port=$2; \
 target.service.protocol=ICP; \
 last

# No log sample; please submit
regex=Accepting HTCP messages on port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts HTCP; \
 id=1812; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid listens for incoming HTCP messages on port $1, file descriptor #$2; \
 target.service.port=$1; \
 target.service.protocol=HTCP; \
 last

# No log sample; please submit
regex=Accepting WCCP messages on port (\d+), FD (\d+)\.; \
 classification.name=Squid accepts WCCP; \
 id=1813; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.completion=succeeded; \
 impact.type=other; \
 impact.description=Squid listens for incoming WCCP messages on port $1, file descriptor #$2; \
 target.service.port=$1; \
 target.service.protocol=WCCP; \
 last

# No log sample; please submit
regex=HTCP Disabled\.; \
 classification.name=Squid started without HTCP; \
 id=1814; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid was invoked without the HTCP service; \
 last

# No log sample; please submit
regex=WCCP Disabled\.; \
 classification.name=Squid started without WCCP; \
 id=1815; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid was invoked without the WCCP service; \
 last

# No log sample; please submit
regex=Squid Parent: child process (\d+) exited; \
 classification.name=Squid stopped; \
 id=1816; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=low; \
 impact.type=other; \
 impact.description=Squid (pid $2) exited; \
 target.node.name=$1; \
 target.process.name=squid; \
 target.process.pid=$2; \
 last


# II. ACL log 
# 1. From /var/log/squid/access.log

# No log sample; please submit
regex=(\d+\.\d+\.\d+\.\d+) .*DENIED/(\d+) (.*); \
 classification.name=Squid acl violation attempt; \
 id=1817; \
 revision=1; \
 classification.origin=vendor-specific; \
 impact.severity=medium; \
 impact.completion=failed; \
 impact.description=Host $1 tried to violate Squid ACL; \
 source.node.address; \
 source.node.address.category=ipv4-addr; \
 source.node.address.address=$2; \
 last
