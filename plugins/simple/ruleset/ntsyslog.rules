#####
#
# Copyright (C) 2003 Vincent Glaume <vglaume@exaprobe.com>
# All Rights Reserved
#
# This file is part of the Prelude program.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by 
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; see the file COPYING.  If not, write to
# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
#
#####

#############################################################################
# 
# This ruleset aims at analyzing the logs returned by the ntsyslog 
# application, which converts NT events to syslog. 
# English logs only.
#
#############################################################################


###
# I. Security events
###

# 1. Success events
# 1.a 515
regex= security\[success\] 515 (.*) Logon Process Name:([\w\\]+); \
 classification(0).name=Windows Event ID [515]: Trusted logon process registration; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=$2 has registered as a trusted logon process; \
 source(0).process.name=$2; \
 last

# 1.b 528
regex= security\[success\] 528 (.*) Successful Logon:  User Name:([\w ]+)  Domain:(.+)  Logon ID:\((.*)\)  Logon Type:(\d+)  Logon Process:(\w+) .* Workstation Name:(\w+); \
 classification(0).name=Windows Event ID [528]: Successful logon; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=user; \
 assessment.impact.description=$2 successfully logged on on $7 ($3 domain) via $6; \
 source(0).user.userid(0).name=$1; \
 last

# 1.c 538
regex= security\[success\] 538 (.*) User Logoff:  User Name:([\w ]+)  Domain:(.+)  Logon ID:\((.*)\)  Logon Type:(\d+); \
 classification(0).name=Windows Event ID [538]: User logoff; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=user; \
 assessment.impact.description=$2 logged off; \
 source(0).user.userid(0).name=$2; \
 last

# 1.d 560
regex= security\[success\] 560 (.*)  Object Open:  Object Server:([\w\s]+)  Object Type:([\w\_]+)  Object Name:(\w+)  New Handle ID:(\d+)  Operation ID:(.*)  Process ID:(\d+)  Primary User Name:(.*)  Primary Domain:(.+)  Primary Logon ID:(.*)  Client User Name:([\w ]+)  Client Domain:(.+)  Client Logon ID:\((.*)\)  .*; \
 classification(0).name=Windows Event ID [560]: Object open; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=$11 opened an object $4 on $2; \
 source(0).user.userid(0).name=$11; \
 target(0).process.pid=$7; \
 last

# 1.e 562
regex= security\[success\] 562 (.*) Handle Closed:  Object Server:([\w\s]+)  Handle ID:(\d+)  Process ID:(\d+); \
 classification(0).name=Windows Event ID [562]: Handle closed; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=Object Handle closed on $2; \
 target(0).process.pid=$4; \
 last

# 1.f 576
regex= security\[success\] 576 (.*)  Special privileges assigned to new logon:  User Name:([\w ]+)  Domain:(.+)  Logon ID:\((.*)\)  Assigned: ([\w\ ]+); \
 classification(0).name=Windows Event ID [576]: Privilege assigned to new logon; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=user; \
 assessment.impact.description=$2 got following privileges: $5; \
 source(0).user.userid(0).name=$2; \
 last

# 1.g 577
regex= security\[success\] 577 (.*)  Privileged Service Called:  Server:(.+)  Service:(.*)  Primary User Name:([\w ]+)  Primary Domain:(.+)  Primary Logon ID:\((.*)\)  Client User Name:(.+)  Client Domain:(.+)  Client Logon ID:(.+)  Privileges:(.+); \
 classification(0).name=Windows Event ID [577]: Privileged service called; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=Service $3 called with the following privileges: $10; \
 source(0).user.userid(0).name=$7; \
 last

# 1.h
regex= security\[success\] 643 (.*)  Domain Policy Changed: Password Policy  modified  Domain:(.+)  Domain ID: (.+)  Caller User Name:(.+)  Caller Domain:(.+)  Caller Logon ID:\((.+)\)  Privileges:(.+); \
 classification(0).name=Windows Event ID [643]: Password policy modified; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=User $4 modified the password policy for the $2 domain; \
 source(0).user.userid(0).name=$4; \
 last

# 1.i 680
regex= security\[success\] 680 (.*)  Account Used for Logon by: (.+)  Account Name: (.+)  Workstation: (.+); \
 classification(0).name=Windows Event ID [680]: Logon attempt; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.type=user; \
 assessment.impact.description=Logon attempt on $4 using the $3 account; \
 target(0).node.name=$4; \
 last

# 1.j 682
regex= security\[success\] 682 (.*)  Session reconnected to winstation:  User Name:([\w ]+)  Domain:(.+)  Logon ID:\((.+)\)  Session Name:(.+)  Client Name:(.+)  Client Address:(\d+\.\d+\.\d+\.\d+); \
 classification(0).name=Windows Event ID [682]: Session reconnected to winstation; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=Session reconnection from $7; \
 source(0).node.address(0).category=ipv4-addr; \
 source(0).node.address(0).address=$7; \
 target(0).user.userid(0).name=$2; \
 last

# 1.k 683
regex= security\[success\] 683 (.*)  Session disconnected from winstation:  User Name:([\w ]+)  Domain:(.+)  Logon ID:\((.+)\)  Session Name:(.+)  Client Name:(.+)  Client Address:(\d+\.\d+\.\d+\.\d+); \
 classification(0).name=Windows Event ID [683]: Session disconnected from winstation; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.completion=succeeded; \
 assessment.impact.type=other; \
 assessment.impact.description=Session reconnection from $7; \
 source(0).node.address(0).category=ipv4-addr; \
 source(0).node.address(0).address=$7; \
 target(0).user.userid(0).name=$2; \
 last

# 1.l other
regex= security\[success\] (\d+); \
 classification(0).name=Windows Event ID [$1]; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=low; \
 assessment.impact.type=other; \
 assessment.impact.description=Security Success message with identifier #$1; \
 last


# 2. Failure events
# 2.a 529 or 534
regex= security\[failure\] (\d+) (.+) Logon Failure:  Reason:(.+)  User Name:([\w ]+)  Domain:(.+)  Logon Type:(\d+)  Logon Process:(\w+)    Authentication Package:(.+)  Workstation Name:(.+); \
 classification(0).name=Windows Event ID [$1]: Logon failure; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=medium; \
 assessment.impact.completion=failed; \
 assessment.impact.type=user; \
 assessment.impact.description=Logon as $4 failed: $3; \
 target(0).node.name=$9; \
 target(0).user.userid(0).name=$4; \
 last

# 2.b 578
regex= security\[failure\] 578 (.+) Privileged object operation:  Object Server:Security  Object Handle:(\d+)  Process ID:(\d+)  Primary User Name:(.+)  Primary Domain:(.+)  Primary Logon ID:\(.*\)  Client User Name:([\w ]+)  Client Domain:(.+)  Client Logon ID:\((.*)\)  Privileges:(.+); \
 classification(0).name=Windows Event ID [578]: Privileged object operation; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=medium; \
 assessment.impact.type=user; \
 target(0).process.pid=$3; \
 source(0).user.userid(0).name=$7; \
 last

# 2.c 627
regex= security\[failure\] 627 (.+)  Change Password Attempt:  Target Account Name:(.+)  Target Domain:(.+)  Target Account ID: (.+)  Caller User Name:(.+)  Caller Domain:(.+)  Caller Logon ID:(\(.+\))  Privileges:(.+); \
 classification(0).name=Windows Event ID [627]: Change password attempt; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=medium; \
 assessment.impact.type=user; \
 assessment.impact.description=$5 attempted to change the password for $2 on the $3 domain; \
 source(0).user.userid(0).name=$5; \
 target(0).user.userid(0).name=$2

# 2.d 681
regex= security\[failure\] 681 (.+)  The logon to account:(.+)  by:(.+)  from workstation: (\w+)  failed. The error code was: (\d+); \
 classification(0).name=Windows Event ID [681]: Logon failure; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=medium; \
 assessment.impact.completion=failed; \
 assessment.impact.type=user; \
 assessment.impact.description=Logon as $2 from $3 failed; \
 target(0).node.name=$3; \
 target(0).user.userid(0).name=$2; \
 last

# 2.e other
regex= security\[failure\] (\d+); \
 classification(0).name=Windows Event ID [$1]; \
 classification(0).origin=vendor-specific; \
 assessment.impact.severity=medium; \
 assessment.impact.type=other; \
 assessment.impact.description=Security Failure message with identifier #$1
